---
- hosts: vsphere_powerdns_vms
  tasks:
    - name: Gathering Info
      setup:
      register: _vsphere_powerdns_vms_info
      tags:
        - vsphere_powerdns_vms_info

    - name: Updating Inventory For vsphere_powerdns_vms
      template:
        src: ../templates/powerdns_vms.inv.j2
        dest: "{{ vsphere_powerdns_vms_inventory_file }}"
      become: false
      delegate_to: localhost
      tags:
        - vsphere_powerdns_vms_info

- hosts: vsphere_powerdns_vms
  roles:
    - role: ansible-change-hostname
    - role: ansible-etc-hosts
    - role: ansible-keepalived
      when: >
            vsphere_dns_servers is defined and
            vsphere_dns_servers != []
    - role: ansible-mariadb-galera-cluster
    - role: ansible-powerdns-authoritative
    - role: ansible-powerdns-recursor
    - role: ansible-apache2
    - role: ansible-phpipam
      become: true
