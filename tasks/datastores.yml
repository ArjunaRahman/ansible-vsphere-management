---
- name: datastores | Managing Datastores
  win_shell: |
    $vmHost="{{ hostvars[item]['ansible_host'] }}"
    Connect-VIServer -Server $vmHost
    Get-DataStore -Server $vmHost -refresh
    $CurrentNFSDataStores=@($(Get-Datastore -Server $vmHost | Where {$_.type -eq "NFS"} | Select-Object -ExpandProperty Name))
    {% for datastore in vsphere_datastores %}
    {%   if datastore['type']|lower == 'nfs' %}
    if ($CurrentNFSDataStores -notcontains '{{ datastore['name'] }}'){
      New-Datastore -Server $vmHost -Nfs -Name '{{ datastore['name'] }}' -Path '{{ datastore['path'] }}' -NfsHost {{ datastore['host'] }}
    {%   endif %}
    }
    {% endfor %}
    Disconnect-VIServer * -Confirm:$false
  with_items: "{{ groups['vsphere_hosts'] }}"
  when: vsphere_datastores is defined
